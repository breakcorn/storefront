# Multi-stage Dockerfile для тестирования
FROM node:20-alpine AS base

# Устанавливаем pnpm, git и системные зависимости для Playwright
RUN corepack enable pnpm && \
    corepack install -g pnpm@10.14.0 && \
    apk add --no-cache git wget chromium nss freetype freetype-dev harfbuzz ca-certificates ttf-freefont

# Устанавливаем переменные среды для Playwright
ENV PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1
ENV PLAYWRIGHT_CHROMIUM_EXECUTABLE_PATH=/usr/bin/chromium-browser

WORKDIR /app

# Stage для установки всех зависимостей включая dev-dependencies
FROM base AS dependencies

# Копируем файлы конфигурации пакетов
COPY package.json pnpm-lock.yaml ./

# Устанавливаем все зависимости включая dev dependencies
RUN pnpm install --frozen-lockfile

# Stage для сборки приложения
FROM dependencies AS build-stage

# Копируем исходный код
COPY . .

# Копируем тестовую конфигурацию среды
COPY .env.test .env

# Генерируем GraphQL типы
RUN pnpm run generate

# Устанавливаем Docker конфигурацию и собираем приложение
RUN cp svelte.config.docker.js svelte.config.js && pnpm run build:test

# Финальный stage для запуска тестов
FROM dependencies AS test

# Копируем собранное приложение (Node адаптер создаёт папку build)
COPY --from=build-stage /app/build ./build/
COPY --from=build-stage /app/.svelte-kit ./.svelte-kit/
COPY --from=build-stage /app/src ./src/
COPY --from=build-stage /app/__tests__ ./__tests__/
COPY --from=build-stage /app/playwright.config.ts ./
COPY --from=build-stage /app/playwright.config.docker.ts ./
COPY --from=build-stage /app/.env.test ./
COPY --from=build-stage /app/package.json ./
COPY --from=build-stage /app/svelte.config.js ./

# Создаем non-root пользователя
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 sveltekit

# Создаем директории для результатов тестов и создаем скрипт запуска
RUN mkdir -p test-results playwright-report && \
    echo '#!/bin/sh' > /app/start-tests.sh && \
    echo 'set -e' >> /app/start-tests.sh && \
    echo 'echo "Запуск приложения..."' >> /app/start-tests.sh && \
    echo 'node build/index.js &' >> /app/start-tests.sh && \
    echo 'APP_PID=$!' >> /app/start-tests.sh && \
    echo 'echo "Ожидание готовности приложения..."' >> /app/start-tests.sh && \
    echo 'for i in \$(seq 1 30); do' >> /app/start-tests.sh && \
    echo '  if wget --no-verbose --tries=1 --spider http://localhost:3000 >/dev/null 2>&1; then' >> /app/start-tests.sh && \
    echo '    echo "Приложение готово!"' >> /app/start-tests.sh && \
    echo '    break' >> /app/start-tests.sh && \
    echo '  fi' >> /app/start-tests.sh && \
    echo '  echo -n "."' >> /app/start-tests.sh && \
    echo '  sleep 2' >> /app/start-tests.sh && \
    echo 'done' >> /app/start-tests.sh && \
    echo 'echo' >> /app/start-tests.sh && \
    echo 'echo "Запуск тестов..."' >> /app/start-tests.sh && \
    echo 'pnpm test' >> /app/start-tests.sh && \
    echo 'TEST_EXIT_CODE=$?' >> /app/start-tests.sh && \
    echo 'echo "Остановка приложения..."' >> /app/start-tests.sh && \
    echo 'kill \$APP_PID 2>/dev/null || true' >> /app/start-tests.sh && \
    echo 'exit \$TEST_EXIT_CODE' >> /app/start-tests.sh && \
    chmod +x /app/start-tests.sh && \
    chown -R sveltekit:nodejs /app

USER sveltekit

# Экспонируем порт
EXPOSE 3000

# Устанавливаем переменные среды
ENV NODE_ENV=test
ENV PORT=3000
ENV CI=true

# Healthcheck для проверки готовности приложения
HEALTHCHECK --interval=10s --timeout=5s --start-period=30s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:3000 || exit 1

# Запуск через скрипт
CMD ["/app/start-tests.sh"]
